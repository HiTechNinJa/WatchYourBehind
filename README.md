# WatchYourBehind
软件工程实训之用。此仓库作为项目源码仓库

# LD2450 ESP32 控制器开发总结

## 1. 通信协议与数据解析

**问题**：雷达上报的数据是十六进制流，包含多目标的 X/Y 坐标、速度等信息，直接看 Hex 码无法理解。

**解决**：

- 参考《LD2450 串口通信协议 V1.03》，实现了 `parseRadarByte` 状态机，自动识别帧头 `AA FF 03 00` 和帧尾 `55 CC`。
- 编写了 `parseCoordinate` 函数，将 raw 数据（如 `0x8000` 补码格式）正确转换为有符号的 `int16_t` 毫米级坐标。
- 实现了 `DATA_PRINT_INTERVAL` (3秒) 限流机制，防止高速刷屏导致控制台卡顿，同时保留心跳 `.` 提示。

## 2. 指令发送与 ACK 确认

**问题**：

- 发送指令（如查询版本 `ver`）后，看不到雷达的反馈，或者反馈是一串看不懂的 Hex。
- 部分指令（如 `reboot`）发送失败，雷达返回错误码 `0x0001`。

**解决**：

- **封装协议**：实现了 `sendRadarPacket` 函数，自动计算包长、添加帧头 `FD FC FB FA` 和帧尾 `04 03 02 01`。
- **智能 ACK 解析**：`waitForAck` 函数不仅检查“成功/失败”，还能根据发送的指令类型（`sentCmd`），自动将返回的数据负载解析为人类可读的格式（如版本号、MAC地址、当前模式）。
- **时序修复**：发现雷达处理状态切换需要时间。在发送 `Enable Config` 后和发送具体指令前，增加了 50ms 的硬延时 (`delay(50)`)，并在这之前清空串口缓冲区，彻底解决了 `reboot` 报错的问题。

## 3. 自动波特率扫描与热启动问题

**问题**：

- 雷达波特率可能是 `256000` 或 `115200`，写死代码会导致连接失败。
- 核心痛点：ESP32 刷写固件重启时，雷达不会断电，会持续向 ESP32 发送高速数据。这导致 ESP32 启动时缓冲区里全是“半截”的脏数据，导致扫描逻辑（只认帧头）误判为“未连接”。

**解决**：

- **自动重试循环**：`scanBaudRate` 不再尝试一次就放弃，而是进入死循环持续轮询，直到锁定成功。
- **脏数据清洗**：新增 `clearSerialBuffer()` 函数，在 `Serial1.begin()` 后和每次扫描前，强制读取并丢弃缓冲区内的所有旧数据，确保从一个全新的、完整的帧头开始解析。
- **双重判定**：扫描逻辑优化，不仅识别坐标帧头 `AA FF`，也识别配置 ACK 帧头 `FD FC`，防止雷达处于静默配置模式时被误判为掉线。

## 4. 安全与交互体验

**问题**：

- 误触 `factory`（恢复出厂）或 `baud`（改波特率）等危险指令会导致失联。
- 想一边用手机 App 调参，一边看串口反馈，但雷达不会主动上报配置变更。

**解决**：

- **二次确认机制**：对 `reboot`, `factory`, `baud` 等指令引入 `requestAction` 流程，必须输入 `yes` 才能执行。
- **后台静默巡检**：利用 `lastKnownMode` 变量，在后台每 10 秒自动查询一次雷达状态。只有当发现状态（如单/多目标模式）发生变化时，才在串口打印 `[Auto-Check] ALERT`，既实现了监控又保持了安静。
- **透传模式**：开发了 `bridge` 命令，让 ESP32 变身 USB-TTL 透传工具，方便直接连接官方 PC 上位机进行深度调试。

## 5. 硬件特性坑

**问题**：发送 `bleoff` 关闭蓝牙显示成功，但手机还能搜到。

**解决**：

- 确认了 LD2450 的硬件机制——蓝牙配置必须重启生效。代码中添加了专门的提示语 `>> NOTICE: Please execute 'reboot'...`，引导用户正确操作。
